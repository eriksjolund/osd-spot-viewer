<!DOCTYPE html>
<html>
  <head>
    <script src="//cdn.rawgit.com/dcodeIO/long.js/3.1.0/dist/long.min.js"></script>
    <script src="//cdn.rawgit.com/dcodeIO/bytebuffer.js/5.0.1/dist/bytebuffer.min.js"></script>
    <script src="//cdn.rawgit.com/dcodeIO/protobuf.js/5.0.1/dist/protobuf.min.js"></script>
    <script src="http://eriksjolund.github.io/temp_web_build_for_osd_spot_viewer/openseadragon/openseadragon.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
    <script type="text/javascript" src="http://openseadragon.github.io/svg-overlay/openseadragon-svg-overlay.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://twitter.github.io/typeahead.js/css/examples.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
    <script type="text/javascript" src="src/entry.js" charset="utf-8"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="jumbotron">
          <h1>Viewer for st_exp_protobuf data</h1>
          <p>Visualize gene expression on top of cell tissues by use of OpenSeadragon</p>
          <div class="span4 collapse-group">
            <p class="collapse" id="view_details">
              <small>Quick start: First select a local <a href="https://github.com/eriksjolund/st_exp_protobuf">st_exp_protobuf</a> file or open a remote URL to a st_exp_protobuf file.
                After that the "add gene" input field will provide auto-completion functionality when typing gene names. Add some genes so that they appear as a new-line-separated list of genes in the gene list. Now click "Create layout from gene list". An OpenSeadragon window will now appear where each of the genes have had its gene expression values painted as circles on top of the cell tissue microscope photos.
                <br/>
                <br/>
                More in-depth information: The <a href="https://github.com/eriksjolund/st_exp_protobuf/">st_exp_protobuf</a> file format stores <a href="https://en.wikipedia.org/wiki/Pyramid_(image_processing)">pyramid</a> image tiles of high-resolution microscope photos that can be displayed by <a href="https://github.com/openseadragon/openseadragon/compare/master...eriksjolund:image_job_start_function">slightly modified</a> <a href="https://openseadragon.github.io/">OpenSeadragon</a>. The file format also contains gene expression values stored indexed by gene. A small header in the beginning of the file contains indexes to the rest of the file. With this design, opening and displaying the gene expression will be very fast because only a fraction of the whole  st_exp_protobuf file needs to be downloaded (or read). The relevant parts of the data will be retrieved as byte ranges.
              </small>
            </p>
            <p><a class="btn btn-primary btn-lg" data-toggle="collapse" data-target="#view_details">Learn more &raquo;</a></p>
          </div>
        </div>
      </div>

      <h2>Experiments</h2>
      <div class="row">
	<div class="col-sm-12">
	  <label class="btn btn-default btn-file">
	    Add local experiment files <input type="file" style="display: none;" id="experiment_files_input" multiple onchange="global.handleExperimentFiles(this.files)">
	  </label>
	  <br/>
	  <!--   <button  onclick="add_osd_window()">add section</button>-->
	</div>
      </div>
      <div class="row" style=" margin-top: 10px;">
	<div class="col-sm-12">
	  <div class="input-group">
            <span class="input-group-btn">
              <button class="btn btn-default" type="button" onclick="global.handleAddExperimentURL()">Add URL to experiment file</button>
            </span>
            <input type="text" id="input_remote_url_to_add" class="form-control" placeholder="Add URL to remote experiment file">
	  </div>
	</div>
      </div>
      <h2>Layouts</h2>
      <h3>Open layouts</h3>
      <div class="row" style=" margin-top: 10px;">
        <div class="col-sm-12">
	  <label class="btn btn-default btn-file">
	    Add local layout file
	    <input type="file" style="display: none;"   id="layout_files_input" multiple onchange="global.handleLayoutFiles(this.files)">
	  </label>
	</div>
      </div>
      <h3>Create layout</h3>
      <div class="row" style=" margin-top: 10px;">
        <div class="col-sm-12">

          <label class="btn btn-default btn-file">
            Add gene

            <input type="text" id="add_gene_input" class="typeahead" />
          </label>

          <textarea id="genes_textarea" cols="20" rows="5"></textarea>
          <button class="btn btn-default" type="button"
               onclick="global.handleCreateLayoutFromGeneList()">Create layout from gene list</button>
        </div>
      </div>
      <div class="row" style=" margin-top: 10px;">
        <div class="col-sm-12">
          <div id="osd_windows"></div>
	  <div>
	    <br/>
	    <b>
              Changes to this web page: June 1st 2016, started to use Javascript ES6 Promises (only tested with Google Chrome and Firefox)
	    </b>
	  </div>
        </div>
      </div>
    </div>

    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <script>
window.osd_layout_image_colors = [];
var global = new Global($('.typeahead'));
var startFunction = function(experiment_files, obj_this) { start_function_experiment(experiment_files, obj_this); }.bind(null, global.experiment_files);

function add_gene_to_list(gene_name) {
    var area = $('#genes_textarea').val();
    var genes = $('#genes_textarea');
    genes.val(genes.val() + gene_name + '\n');
    // Reset gene name field
    $('.typeahead').typeahead('val','');
}

var updater = function(evt, gene_name) {
    add_gene_to_list(gene_name);
    return '';
};

$('.typeahead').bind('typeahead:selected', function(ev, suggestion) {
    add_gene_to_list(suggestion );
});

$('.typeahead').bind("keypress", {}, function (ev) {
    if (ev.keyCode == 13) {
        ev.preventDefault();
        var gene_input_value = $('#add_gene_input').val();
        add_gene_to_list(gene_input_value );
    }
}
);
    </script>
  </body>
</html>
